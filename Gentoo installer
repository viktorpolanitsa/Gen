#!/bin/bash
set -e

# -----------------------------
# Проверка root
# -----------------------------
if [[ $EUID -ne 0 ]]; then
    echo "Run this script as root!"
    exit 1
fi

# -----------------------------
# Проверка dialog
# -----------------------------
if ! command -v dialog &>/dev/null; then
    echo "Installing dialog..."
    emerge --verbose app-misc/dialog
fi

CPU_CORES=$(nproc)
KERNEL_LOG="/var/log/kernel_build_$(date +%F_%H-%M-%S).log"
XFCE_LOG="/var/log/xfce_install_$(date +%F_%H-%M-%S).log"

# -----------------------------
# Функция проверки статуса
# -----------------------------
check_status() {
    if [[ $? -ne 0 ]]; then
        echo "[ERROR] $1 failed! Check logs."
        exit 1
    fi
}

# -----------------------------
# Функция прогресс-бара
# -----------------------------
progress_bar() {
    local cmd="$1"
    "$cmd" 2>&1 | while IFS= read -r line; do
        echo "$line"
    done
}

# -----------------------------
# Шаг 1: Выбор ядра
# -----------------------------
KERNELS=($(ls -d /usr/src/linux-* | sed 's|/usr/src/||'))
KERNEL_CHOICE=$(dialog --stdout --menu "Choose kernel version:" 20 70 10 \
    $(for k in "${KERNELS[@]}"; do echo "$k" "$k"; done))
clear
KERNEL_SRC="/usr/src/$KERNEL_CHOICE"
if [[ ! -d "$KERNEL_SRC" ]]; then
    echo "[ERROR] Kernel source $KERNEL_SRC not found!"
    exit 1
fi

# -----------------------------
# Шаг 2: Выбор опций
# -----------------------------
OPTIONS=$(dialog --stdout --checklist "Select actions to perform:" 20 70 10 \
"backup" "Backup current kernel/initramfs" on \
"kernel_build" "Build and install kernel" on \
"xfce" "Install XFCE/Xorg" on \
"autologin" "Enable autologin for LightDM" off \
"cpu_opt" "Enable CPU frequency scaling/power saving" on \
"gpu_opt" "Enable Radeon DRM/KMS/DPM" on \
"hdd_opt" "Enable laptop-mode-tools/HDD optimizations" on)

clear
echo "[INFO] Selected options: $OPTIONS"

# -----------------------------
# Шаг 3: Проверка и установка зависимостей
# -----------------------------
DEPENDENCIES="sys-kernel/gentoo-sources sys-devel/gcc sys-devel/make sys-power/laptop-mode-tools x11-base/xorg-drivers x11-base/xorg-server x11-misc/mesa app-admin/eselect xfce4 xfce4-goodies lightdm lightdm-gtk-greeter"
for pkg in $DEPENDENCIES; do
    if ! equery list "$pkg" &>/dev/null; then
        echo "[INFO] Installing missing package: $pkg"
        emerge --verbose --autounmask-write "$pkg"
        etc-update --automode -5
        emerge --verbose "$pkg"
        check_status "Installation of $pkg"
    fi
done

# -----------------------------
# Шаг 4: Резервное копирование ядра
# -----------------------------
if [[ $OPTIONS =~ "backup" ]]; then
    BACKUP_DIR="/boot/backup_kernel_$(date +%F_%H-%M-%S)"
    mkdir -p "$BACKUP_DIR"
    cp /boot/vmlinuz-* "$BACKUP_DIR/" || true
    cp /boot/initramfs-* "$BACKUP_DIR/" || true
    echo "[INFO] Backup saved in $BACKUP_DIR"
fi

# -----------------------------
# Шаг 5: Создание symlink
# -----------------------------
cd /usr/src
if [[ -L linux || -e linux ]]; then
    rm -f linux
fi
ln -s "$KERNEL_SRC" linux
cd linux

# -----------------------------
# Шаг 6: Конфигурация ядра
# -----------------------------
if [[ $OPTIONS =~ "kernel_build" ]]; then
    make defconfig
    check_status "defconfig"

    # Основные драйверы
    scripts/config --enable BLK_DEV_SD
    scripts/config --enable ATA
    scripts/config --enable SCSI_MOD
    scripts/config --enable AHCI
    scripts/config --enable EXT4_FS
    scripts/config --enable EXT2_FS
    scripts/config --enable XFS_FS
    scripts/config --enable XFS_QUOTA
    scripts/config --enable USB
    scripts/config --enable USB_EHCI_HCD
    scripts/config --enable USB_UHCI_HCD
    scripts/config --enable USB_OHCI_HCD
    scripts/config --enable USB_XHCI_HCD
    scripts/config --enable USB_STORAGE
    scripts/config --disable MODULE_SIG
    scripts/config --disable MODULE_SIG_ALL
    scripts/config --disable MODULE_SIG_HASH

    # CPU оптимизации
    [[ $OPTIONS =~ "cpu_opt" ]] && {
        scripts/config --enable CPU_FREQ
        scripts/config --enable CPU_FREQ_GOV_ONDEMAND
        scripts/config --enable CPU_FREQ_STAT
        scripts/config --enable CPU_IDLE
    }

    # GPU оптимизации
    [[ $OPTIONS =~ "gpu_opt" ]] && {
        scripts/config --enable DRM
        scripts/config --enable DRM_RADEON
        scripts/config --enable DRM_KMS_HELPER
        scripts/config --enable RADEON_DPM
        echo "options radeon dpm=1" > /etc/modprobe.d/radeon.conf
    }

    make olddefconfig
    check_status "olddefconfig"

    # Сборка ядра с прогрессом
    echo "Building kernel..."
    progress_bar "make -j$CPU_CORES V=1" | tee "$KERNEL_LOG"
    check_status "Kernel build"

    echo "Installing modules..."
    progress_bar "make modules_install" | tee -a "$KERNEL_LOG"
    check_status "Modules install"

    echo "Installing kernel..."
    progress_bar "make install" | tee -a "$KERNEL_LOG"
    check_status "Kernel install"

    echo "Updating GRUB..."
    grub-mkconfig -o /boot/grub/grub.cfg 2>&1 | tee -a "$KERNEL_LOG"
    check_status "GRUB update"
fi

# -----------------------------
# Шаг 7: Установка XFCE/Xorg
# -----------------------------
if [[ $OPTIONS =~ "xfce" ]]; then
    XFCE_PACKAGES="xfce4 xfce4-goodies lightdm lightdm-gtk-greeter xorg-server xorg-apps xorg-drivers mesa"
    emerge --verbose $XFCE_PACKAGES 2>&1 | tee "$XFCE_LOG"

    [[ $OPTIONS =~ "autologin" ]] && {
        sed -i 's/#autologin=.*/autologin=your_user/' /etc/conf.d/lightdm
    }

    rc-update add lightdm default
fi

# -----------------------------
# Шаг 8: Оптимизация энергопотребления
# -----------------------------
if [[ $OPTIONS =~ "hdd_opt" ]]; then
    rc-update add laptop-mode default
    rc-update add cpufreq default
    echo "vm.swappiness=10" >> /etc/sysctl.conf
    echo "vm.vfs_cache_pressure=50" >> /etc/sysctl.conf
fi

dialog --msgbox "Installation completed! Reboot to use the new kernel and environment." 8 70
clear
